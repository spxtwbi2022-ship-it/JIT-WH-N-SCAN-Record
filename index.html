<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æƒç®±ç³»çµ±</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body{font-family:system-ui, -apple-system, 'Noto Sans TC', sans-serif; padding:12px}
#controls{display:flex; gap:8px; margin-bottom:8px}
#log{white-space:pre-wrap; max-height:200px; overflow:auto; background:#f7f7f7; padding:8px}
button{padding:8px 12px}
</style>
</head>
<body>
<h2>æ¥Šæ¢…æƒç®±ç³»çµ±</h2>

<div id="controls">
<!-- <label>Driver ID: <input id="driverId" placeholder="è¼¸å…¥å¸æ©Ÿç·¨è™Ÿ" /></label> -->
<!-- <label>Seller: <select id="seller" placeholder="è³£å®¶åç¨±/ç·¨è™Ÿ (å¯é¸)" /></label> -->
<!-- <label>å°ˆè»Šç·¨è™Ÿ: 
    <select id="whTruckNumber">
        <option value="">-- è¼‰å…¥å°ˆè»Šä¸­... --</option>
    </select>
</label>
<label>è³£å®¶åç¨±:Â 
Â  Â  <select id="seller">
Â  Â  Â  Â  <option value="">-- è«‹å…ˆé¸æ“‡å°ˆè»Š --</option>
Â  Â  </select>
</label> -->
<button id="btnStartCamera">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
<!-- <button id="btnStartScanner">å•Ÿå‹•åˆ·æ§æƒæ</button> -->
<button id="btnStop">åœæ­¢</button>
<button id="btnSync">ç«‹å³ä¸Šå‚³</button>
</div>


<div id="qr-reader" style="width:100%; max-width:480px; margin-bottom:8px"></div>
<div id="status">å°šæœªé–‹å§‹æƒæ</div>
<h4>
    æƒæç´€éŒ„ï¼ˆsessionï¼‰
    <span style="font-size: 0.7em; color: #666;">
        [è«‹å¾…è³‡æ–™éƒ½ä¸Šå‚³å¾Œå†æŒ‰ä¸‹[åœæ­¢]æŒ‰éˆ•ï¼Œè¬è¬!]
    </span>
</h4>
<!-- <h4>ç•¶å‰ä½œæ¥­ç¸½è¨ˆï¼š<span id="totalCount">0</span> ç­†</h4> -->
<h4>
    ç¸½è¨ˆæƒæï¼š<span id="totalCount">0</span> ç­† | 
    å·²ä¸Šå‚³ï¼š<span id="uploadedCount">0</span> ç­† |
    å¾…ä¸Šå‚³ï¼š<span id="pendingCount">0</span> ç­†
</h4>
<table id="scanTable" style="width:100%; border-collapse: collapse; margin-bottom: 12px; border: 1px solid #ccc;">
    <thead>
        <tr style="background: #e7e7e7;">
            <th style="padding: 4px; border: 1px solid #ccc;">#</th>
            <th style="padding: 4px; border: 1px solid #ccc;">è³£å®¶</th>
            <th style="padding: 4px; border: 1px solid #ccc;">æƒæç·¨è™Ÿ (QR Code)</th>
            <th style="padding: 4px; border: 1px solid #ccc;">ç‹€æ…‹</th> </tr>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
<div id="log"></div>

<script src="config.js"></script>
<script>
// CONFIG from config.js: GAS_ENDPOINT, BATCH_SIZE, BATCH_TIMEOUT_MS
// const driverInput = document.getElementById('driverId');
// const sellerInput = document.getElementById('seller');
const whTruckNumberSelect = document.getElementById('whTruckNumber'); // ğŸ‘ˆ æ–°å¢å°ˆè»Šä¸‹æ‹‰é¸å–®è®Šæ•¸
const sellerSelect = document.getElementById('seller');
// const btnStart = document.getElementById('btnStart');
// è®Šæ›´ï¼šå°‡ btnStart è®Šæ•¸é‡æ–°å‘½åä¸¦æ–°å¢åˆ·æ§æŒ‰éˆ•è®Šæ•¸
const btnStartCamera = document.getElementById('btnStartCamera'); // ğŸ‘ˆ å¾ btnStart è®Šæ›´
const btnStartScanner = document.getElementById('btnStartScanner'); // ğŸ‘ˆ æ–°å¢
const btnStop = document.getElementById('btnStop');
const btnSync = document.getElementById('btnSync');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');

// æƒæç›¸é—œè®Šæ•¸
const totalCountEl = document.getElementById('totalCount');
const scanTableBody = document.querySelector('#scanTable tbody');

const uploadedCountEl = document.getElementById('uploadedCount'); 
const pendingCountEl = document.getElementById('pendingCount');

// éŸ³æ•ˆç›¸é—œè®Šæ•¸å’Œå‡½å¼ - ä½¿ç”¨ Web Audio API
let audioContext = null;

let html5QrScanner = null;
let isScanning = false; // è¿½è¹¤ç›¸æ©Ÿæƒæç‹€æ…‹
let isScannerMode = false; // ğŸ‘ˆ æ–°å¢ï¼šè¿½è¹¤æ˜¯å¦è™•æ–¼åˆ·æ§æƒææ¨¡å¼
    
let buffer = []; // æœªé€å‡ºçš„æƒæè³‡æ–™
let sending = false;
let timerId = null;

// è¼‰å…¥ local cache çš„æœªé€å‡ºè³‡æ–™
const LOCAL_KEY = 'qr_scan_offline_buffer_v1';

function updateScanList(){
    // â¬‡ï¸ ã€ä¿®æ”¹é»ã€‘æ–°å¢è¨ˆæ•¸é‚è¼¯
    let uploadedCount = 0;
    
    // æ›´æ–°ç¸½è¨ˆ
    totalCountEl.textContent = buffer.length;

    // æ¸…ç©ºè¡¨æ ¼
    scanTableBody.innerHTML = ''; 
    
    // éæ­· bufferï¼Œå¾æœ€æ–°æƒæçš„é–‹å§‹é¡¯ç¤º (åå‘)
    for(let i = buffer.length - 1; i >= 0; i--){
        const item = buffer[i];
        const row = scanTableBody.insertRow();
        row.insertCell().textContent = i + 1; // åºè™Ÿ
        row.insertCell().textContent = item.seller; // è³£å®¶åç¨±
        row.insertCell().textContent = item.code; // QR Code ç·¨è™Ÿ
        // è™•ç† sent ç‹€æ…‹
        const statusCell = row.insertCell();

        if(item.sent){
            row.style.backgroundColor = '#d4edda'; // æ·ºç¶ è‰²èƒŒæ™¯
            statusCell.textContent = 'âœ… å·²ä¸Šå‚³';
            uploadedCount++; // çµ±è¨ˆå·²ä¸Šå‚³ç­†æ•¸
        } else {
            statusCell.textContent = 'â³ å¾…ä¸Šå‚³';
        }
    }
    // â¬‡ï¸ ã€ä¿®æ”¹é»ã€‘æ›´æ–°ä¸‰å€‹è¨ˆæ•¸å™¨
    uploadedCountEl.textContent = uploadedCount;
    pendingCountEl.textContent = buffer.length - uploadedCount;
}
    
function loadLocalBuffer(){
    try{
        const raw = localStorage.getItem(LOCAL_KEY);
        if(raw){ 
            buffer = JSON.parse(raw); 
            appendLog(`å¾ localStorage è¼‰å…¥ ${buffer.length} ç­†`); 
        }
    }catch(e){ console.error(e);} 
    // ã€ä¿®æ”¹é»ã€‘è¼‰å…¥ç·©å­˜å¾Œæ›´æ–°åˆ—è¡¨
    updateScanList(); 
}

    
function saveLocalBuffer(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(buffer)); }


// function appendLog(text){
// logEl.textContent = new Date().toLocaleTimeString() + ' - ' + text + '\n' + logEl.textContent;
// }
// ã€ä¿®æ­£å€åŸŸ 1: ç¢ºä¿æ—¥èªŒè¼¸å‡ºå®‰å…¨ã€‘
function appendLog(text){
    // é™åˆ¶æ—¥èªŒè¨Šæ¯é•·åº¦ï¼Œé¿å…é¡¯ç¤ºå®Œæ•´çš„ HTML éŒ¯èª¤é é¢
    let safeText = String(text);
    
    // æª¢æŸ¥è¨Šæ¯æ˜¯å¦åƒæ˜¯ HTML å…§å®¹ (ä¾‹å¦‚åŒ…å« <html æˆ– <body ç­‰) æˆ–è¨Šæ¯éé•·ï¼Œé€²è¡Œæˆªæ–·
    if (safeText.includes('<html') || safeText.includes('<body') || safeText.length > 500) {
        safeText = safeText.substring(0, 500) + '... (è¼‰å…¥éŒ¯èª¤è¨Šæ¯éé•·æˆ–åŒ…å« HTML å·²æˆªæ–·)';
    }

    logEl.textContent = new Date().toLocaleTimeString() + ' - ' + safeText + '\n' + logEl.textContent;
}

function initAudioContext() {
    if (audioContext) return;
    try {
        // å˜—è©¦å»ºç«‹ AudioContext
        // ç”±æ–¼ç€è¦½å™¨å¯èƒ½éœ€è¦å‰ç¶´ï¼Œé€™è£¡ä½¿ç”¨ window.AudioContext æˆ– window.webkitAudioContext
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContextClass();
        console.log("AudioContext åˆå§‹åŒ–æˆåŠŸ");
    } catch (e) {
        console.warn("ç„¡æ³•åˆå§‹åŒ– AudioContext:", e);
    }
}

// ä½¿ç”¨ Web Audio API ç”Ÿæˆä¸€å€‹çŸ­ä¿ƒçš„ Beep è²éŸ³
function playBeep() {
    if (!audioContext) {
        // å¦‚æœ AudioContext å°šæœªåˆå§‹åŒ– (å¯èƒ½å› ç‚ºé¦–æ¬¡æ’­æ”¾è¢«é˜»æ­¢)ï¼Œå‰‡å˜—è©¦åˆå§‹åŒ–
        initAudioContext();
        if (!audioContext) return;
    }
    
    // Web Audio API çš„è²éŸ³ç”Ÿæˆé‚è¼¯
    const duration = 0.1; // è²éŸ³æŒçºŒæ™‚é–“ (ç§’)
    const frequency = 880; // è²éŸ³é »ç‡ (Hz, A5 éŸ³é«˜)
    const volume = 0.5;
    
    // å»ºç«‹éœ‡ç›ªå™¨ (Oscillator)
    const oscillator = audioContext.createOscillator();
    // å»ºç«‹å¢ç›Šç¯€é» (GainNode) ä¾†æ§åˆ¶éŸ³é‡
    const gainNode = audioContext.createGain();

    oscillator.type = 'square'; // æ–¹æ³¢è²éŸ³è¼ƒç‚ºå°–éŠ³ï¼Œé©åˆå—¶å—¶è²
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
    
    // é€£æ¥ç¯€é»: éœ‡ç›ªå™¨ -> å¢ç›Š -> è¼¸å‡º
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    // é–‹å§‹å’ŒçµæŸè²éŸ³
    oscillator.start();
    // è²éŸ³åœ¨ duration æ™‚é–“å¾ŒçµæŸ
    oscillator.stop(audioContext.currentTime + duration);

    // (å¯é¸) åœ¨è²éŸ³çµæŸå¾Œï¼Œå°‡éŸ³é‡å¿«é€Ÿé™ç‚º 0ï¼Œé¿å…çˆ†éŸ³
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
}

// function playBeep() {
//     // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ Audio
//     if (typeof Audio === 'undefined') {
//         console.warn('Audio API is not supported.');
//         return;
//     }

//     if (!audio) {
//         // ä½¿ç”¨ä¸€å€‹éå¸¸çŸ­ä¿ƒã€æ¨™æº–çš„å—¶å—¶è²MP3æ–‡ä»¶ (æ‚¨å¯ä»¥æ›¿æ›ç‚ºè‡ªå·±çš„éŸ³é »è·¯å¾‘)
//         // ç‚ºäº†ç¢ºä¿èˆ‡æ‰€æœ‰ç€è¦½å™¨ç›¸å®¹ï¼Œä½¿ç”¨ base64 æ•¸æ“šæœƒæ›´å¯é ï¼Œä½†é€™è£¡ç¤ºç¯„ä½¿ç”¨æœ€å¸¸è¦‹çš„æª”æ¡ˆé¡å‹
//         // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨äº†ä¸€å€‹å¸¸è¦‹çš„æ¨¡æ“¬å—¶å—¶è²çš„ç¶²è·¯è³‡æºä½œç‚ºç¯„ä¾‹ã€‚
//         audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
//         // è¨­ç½®éŸ³é‡ï¼Œé¿å…è²éŸ³éå¤§
//         audio.volume = 0.5; 
//     }
    
//     // é‡æ–°è¼‰å…¥ä¸¦æ’­æ”¾ (ç¢ºä¿åœ¨å¤šæ¬¡æƒæä¸­éƒ½èƒ½éŸ¿èµ·)
//     audio.currentTime = 0; // å¾é ­é–‹å§‹æ’­æ”¾
//     audio.play().catch(error => {
//         // æ•æ‰ç€è¦½å™¨å¯èƒ½å› æ¬Šé™å•é¡Œé˜»æ­¢æ’­æ”¾çš„éŒ¯èª¤
//         console.warn("ç„¡æ³•æ’­æ”¾éŸ³é » (å¯èƒ½éœ€è¦ç”¨æˆ¶äº’å‹•):", error);
//     });
// }
    
function enqueue(code){
    // ã€æ–°å¢ã€‘æ’­æ”¾éŸ³æ•ˆ
    playBeep();
    
    // â¬‡ï¸ ã€æ–°å¢ï¼šæª¢æŸ¥æ‰€æœ‰æ­·å²ç´€éŒ„ã€‘
    // ä½¿ç”¨ Array.prototype.some() æª¢æŸ¥ buffer ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç·¨è™Ÿ (code) çš„ç´€éŒ„
    const isDuplicate = buffer.some(item => item.code === code); 
    
    if(isDuplicate){
        // å¦‚æœç™¼ç¾é‡è¤‡ï¼Œå‰‡è¨˜éŒ„æ—¥èªŒä¸¦é€€å‡ºï¼Œä¸å°‡å…¶åŠ å…¥ buffer
        appendLog(`âš ï¸ å¿½ç•¥é‡è¤‡æƒæ: ${code} (å·²åœ¨æ­·å²ç´€éŒ„ä¸­)`); 
        return; 
    }
    // â¬†ï¸ ã€çµæŸï¼šæª¢æŸ¥æ‰€æœ‰æ­·å²ç´€éŒ„ã€‘
    
    const now = new Date(); // å‰µå»º Date ç‰©ä»¶

    // â¬‡ï¸ ã€é—œéµä¿®æ”¹ã€‘å°‡æ™‚é–“æˆ³ç›´æ¥è½‰æ›æˆæœ¬åœ°æ™‚å€å­—ä¸²
    const localTimeString = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false, // 24 å°æ™‚åˆ¶
        timeZone: 'Asia/Taipei' // ç¢ºä¿æ˜¯å°ç£æ™‚é–“
    });
    
    const item = {
        code: code,
        // driver: driverInput.value || 'unknown',
        // â¬‡ï¸ é€™è£¡ä¿®æ”¹ç‚ºå‚³é€å°ˆè»Šç·¨è™Ÿ
        // driver: whTruckNumberSelect.value || 'unknown',
        // seller: sellerSelect.value || '',
        driver: '',   // ç•™ç©º
        seller: '',   // ç•™ç©º
        // â¬‡ï¸ å°‡ ts æ¬„ä½å„²å­˜ç‚ºæœ¬åœ°åŒ–å­—ä¸² (æ‚¨å¸Œæœ›å¯«å…¥ Sheet çš„æ ¼å¼)
        ts: localTimeString
        // ts: new Date().toISOString()
    };
    // simple session dedupe // ç”±æ–¼æˆ‘å€‘å·²ç¶“æª¢æŸ¥äº†æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä¸éœ€è¦åŸä¾†çš„ "simple session dedupe" æª¢æŸ¥ã€‚
    // const last = buffer[buffer.length-1];
    // if(last && last.code === item.code)
    //     { appendLog('å¿½ç•¥é‡è¤‡æƒæ: '+item.code); 
    //      return; 
    // }
    
    buffer.push(item);
    saveLocalBuffer();
    // appendLog('åŠ å…¥ buffer: '+code+' (buffer='+buffer.length+')'); // èˆŠæ—¥èªŒå¯è¨»è§£æ‰
    appendLog(`ğŸŸ¢ æƒåˆ°: ${code}`); // æ–°æ—¥èªŒé¡¯ç¤º
    
    // ã€ä¿®æ”¹é»ã€‘å‘¼å«æ›´æ–°åˆ—è¡¨
    updateScanList();
    if(buffer.length >= BATCH_SIZE) sendBatch();
}

// åˆ·æ§æƒæé‚è¼¯çš„ç·©è¡å€
let scannerBuffer = ''; 
let scannerTimer = null; // ç”¨æ–¼åˆ¤æ–·è¼¸å…¥çµæŸ

// æ¢ç¢¼è¼¸å…¥çµæŸçš„å»¶é²æ™‚é–“ (ms)ï¼Œåˆ·æ§è¼¸å…¥é€šå¸¸å¾ˆå¿«ï¼Œé€™å€‹å»¶é²è¶³å¤ å€åˆ†æ‰‹å‹•è¼¸å…¥
const SCANNER_TIMEOUT_MS = 250; 

// ã€æ–°å¢ã€‘éš±è—è¼¸å…¥æ¡†ç”¨æ–¼æ¥æ”¶åˆ·æ§è¼¸å…¥ï¼ˆç¹éè¼¸å…¥æ³•ï¼‰
let scannerInputField = null;

// function handleScannerInput(event) {
//     // 1. åªæœ‰åœ¨åˆ·æ§æ¨¡å¼å•Ÿå‹•æ™‚æ‰åŸ·è¡Œ
//     if (!isScannerMode) return;

//     // --- ã€ä¿®æ”¹è™•ã€‘æ–°å¢é™¤éŒ¯ Log ä¾†æ•ç²è¢«å¿½ç•¥çš„åŠŸèƒ½éµ ---æª¢æŸ¥æ˜¯å¦æ”¶åˆ°ä»»ä½•æŒ‰éµäº‹ä»¶
//     const isFiltered = (event.key.length !== 1 && event.key !== 'Enter');
//     if (isFiltered) {
//         appendLog(`âš ï¸ [è¢«å¿½ç•¥] åµæ¸¬åˆ°åŠŸèƒ½éµã€‚Key: ${event.key}, é•·åº¦: ${event.key.length}`);
//     }
    
//     // 2. ä¸è¦çœ‹åŠŸèƒ½éµ
//     // if (event.key.length !== 1 && event.key !== 'Enter') return; 

//     // 3. é‡ç½®è¨ˆæ™‚å™¨ï¼šæ¯ä¸€æ¬¡æŒ‰éµéƒ½é‡ç½®ï¼Œç¢ºä¿åœ¨çŸ­æ™‚é–“å…§å®Œæˆçš„è¼¸å…¥è¢«è¦–ç‚ºä¸€å€‹æ¢ç¢¼
//     if (scannerTimer) clearTimeout(scannerTimer);

//     // 4. æª¢æŸ¥æ˜¯å¦ç‚ºæ¢ç¢¼çµæŸç¬¦è™Ÿ (é€šå¸¸æ˜¯ Enter)
//     if (event.key === 'Enter') {
//         event.preventDefault(); // é˜»æ­¢æ›è¡Œæˆ–è¡¨å–®æäº¤
        
//         const code = scannerBuffer.trim();
//         scannerBuffer = ''; // æ¸…ç©ºç·©è¡å€
        
//         if (code) {
//             statusEl.textContent = 'æƒåˆ°: ' + code;
//             enqueue(code); // å‚³é€çµ¦ç¾æœ‰çš„è™•ç†é‚è¼¯
//             // **ã€æ–°å¢é™¤éŒ¯é» Aã€‘** è¼¸å‡ºæˆåŠŸè™•ç†çš„ Log
//             appendLog(`[åˆ·æ§æˆåŠŸ] è™•ç†ä»£ç¢¼: ${code}`); 
//         } else {
//              // **ã€æ–°å¢é™¤éŒ¯é» Bã€‘** è¼¸å‡ºç©ºçš„ Enter Log
//              appendLog('âš ï¸ [åˆ·æ§] æ”¶åˆ° Enterï¼Œä½†ç·©è¡å€ç‚ºç©ºï¼Œå¿½ç•¥ã€‚');
//         }
//     } 
//     // **ã€æ–°å¢é‚è¼¯ã€‘**ï¼šå¦‚æœä¸æ˜¯ Enter éµï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆå­—ç¬¦ï¼Œç„¶å¾Œç´¯ç©
//     else {
//         // å¿½ç•¥é•·åº¦å¤§æ–¼ 1 çš„åŠŸèƒ½éµï¼Œå› ç‚ºå®ƒå€‘é€šå¸¸ä¸åŒ…å«æ¢ç¢¼æ•¸æ“š
//         if (event.key.length > 1) {
//             // é€™æœƒæ•ç²åˆ° TVantennaCable ç­‰éµï¼Œä¸¦ç›´æ¥å¿½ç•¥å…¶æ•¸æ“šï¼Œä½†ä¸æœƒæ¸…ç©ºç·©è¡å€
//             appendLog(`âš ï¸ [åˆ·æ§] å¿½ç•¥é•·åº¦ > 1 çš„åŠŸèƒ½éµ: ${event.key}`);
//             return;}

//         // 5. ç´¯ç©å­—ç¬¦ï¼šé€™è£¡å°‡æœƒç´¯ç© 'T', 'V', 'a', 'n', 't', 'e', 'n', 'n', 'a', 'C', 'a', 'b', 'l', 'e' ç­‰æ‰€æœ‰å­—ç¬¦
//         scannerBuffer += event.key;

//         // ã€æ–°å¢é™¤éŒ¯é» Cã€‘ å³æ™‚è¼¸å‡ºç´¯ç©çš„å­—ç¬¦å’Œç·©è¡å€
//         appendLog(`[åˆ·æ§è¼¸å…¥ä¸­] éµ: ${event.key}, ç·©è¡å€: ${scannerBuffer}`);
        
//         // 6. è¨­å®šè¨ˆæ™‚å™¨ï¼šå¦‚æœåœ¨ 50ms å…§æ²’æœ‰æ–°çš„è¼¸å…¥ï¼Œå‰‡é€²è¡Œè¶…æ™‚çµç®—
//         scannerTimer = setTimeout(() => {
//             if (scannerBuffer) {
//                 // å¦‚æœè¶…æ™‚ï¼Œè¡¨ç¤ºåˆ·æ§ç¼ºå°‘ Enterï¼Œæˆ‘å€‘åœ¨é€™è£¡å°‡æ•¸æ“šå¼·è¡Œçµç®—ã€‚
//                 const code = scannerBuffer.trim();
//                 scannerBuffer = '';
                
//                 // åªæœ‰åœ¨è¶…æ™‚ä¸” code æœ‰å…§å®¹æ™‚æ‰çµç®—ä¸¦å ±è­¦
//                 if (code) {
//                     statusEl.textContent = 'æƒåˆ° (è¶…æ™‚): ' + code;
//                     enqueue(code);
//                     // æ³¨æ„ï¼šè¶…æ™‚çµç®—æ™‚ï¼Œcode å¯èƒ½æœƒåŒ…å«åŠŸèƒ½éµçš„åç¨± (ä¾‹å¦‚ 'TVantennaCable12345')
//                     appendLog(`ğŸŸ  [åˆ·æ§è¶…æ™‚çµç®—] âš ï¸ ç¼ºå°‘ Enterï¼å¼·è¡Œçµç®—ä»£ç¢¼: ${code}`);
//                 } else {
//                     appendLog(`[åˆ·æ§] è¼¸å…¥è¶…æ™‚ï¼Œç·©è¡å€æ¸…ç©º: (ç„¡æ•¸æ“š)`);
//                 }
//             }
//         }, SCANNER_TIMEOUT_MS);
//     }
// }

function handleScannerInput(event) {
    // 1. åªæœ‰åœ¨åˆ·æ§æ¨¡å¼å•Ÿå‹•æ™‚æ‰åŸ·è¡Œ
    if (!isScannerMode) return;

    // 2. ã€æ ¸å¿ƒä¿®æ­£ã€‘åªæ¥å—å¯æ‰“å°å­—ç¬¦å’Œ Enter éµ
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆå­—ç¬¦ (æ•¸å­—ã€å­—æ¯ã€å¸¸è¦‹ç¬¦è™Ÿ)
    const isValidChar = /^[a-zA-Z0-9\-_\.]$/.test(event.key);
    const isEnter = event.key === 'Enter';
    
    // å¦‚æœæ—¢ä¸æ˜¯æœ‰æ•ˆå­—ç¬¦ä¹Ÿä¸æ˜¯ Enter,ç›´æ¥å¿½ç•¥
    if (!isValidChar && !isEnter) {
        // ã€å¯é¸ã€‘é™¤éŒ¯ç”¨:è¨˜éŒ„è¢«éæ¿¾çš„æŒ‰éµ
        if (event.key.length > 1) {
            appendLog(`âš ï¸ [å·²éæ¿¾] åŠŸèƒ½éµ: ${event.key}`);
        }
        return;
    }

    // 3. é‡ç½®è¨ˆæ™‚å™¨
    if (scannerTimer) clearTimeout(scannerTimer);

    // 4. æª¢æŸ¥æ˜¯å¦ç‚ºæ¢ç¢¼çµæŸç¬¦è™Ÿ (Enter)
    if (isEnter) {
        event.preventDefault(); // é˜»æ­¢æ›è¡Œæˆ–è¡¨å–®æäº¤
        
        const code = scannerBuffer.trim();
        scannerBuffer = ''; // æ¸…ç©ºç·©è¡å€
        
        if (code) {
            statusEl.textContent = 'æƒåˆ°: ' + code;
            enqueue(code);
            appendLog(`âœ… [åˆ·æ§æˆåŠŸ] ${code}`); 
        } else {
            appendLog('âš ï¸ [åˆ·æ§] Enter ä½†ç·©è¡å€ç©ºç™½');
        }
    } 
    // 5. ç´¯ç©æœ‰æ•ˆå­—ç¬¦
    else if (isValidChar) {
        scannerBuffer += event.key;
        
        // 6. è¨­å®šè¶…æ™‚è¨ˆæ™‚å™¨ (å‚™ç”¨æ©Ÿåˆ¶)
        scannerTimer = setTimeout(() => {
            const code = scannerBuffer.trim();
            scannerBuffer = '';
            
            if (code) {
                statusEl.textContent = 'æƒåˆ° (è¶…æ™‚): ' + code;
                enqueue(code);
                appendLog(`ğŸŸ  [åˆ·æ§è¶…æ™‚] ç„¡ Enter,å¼·åˆ¶çµç®—: ${code}`);
            }
        }, SCANNER_TIMEOUT_MS);
    }
}

// ã€æœ€çµ‚ç‰ˆæœ¬ï¼šä¿®å¾©é€£ç™¼ã€æœªå®šç¾©è®Šæ•¸å’Œå‚³é€éŒ¯èª¤ã€‘
async function sendBatch(){
    if(sending) return;
    
    // â¬‡ï¸ ã€æ­¥é©Ÿ 1ï¼šå»ºç«‹åŒ…å«ç´¢å¼•çš„å¾…ä¸Šå‚³æ¸…å–®ã€‘
    const indexedPending = buffer
        .map((item, index) => ({ item, index }))
        .filter(entry => !entry.item.sent);

    // æª¢æŸ¥æ˜¯å¦æœ‰å¾…ä¸Šå‚³è³‡æ–™
    if(indexedPending.length === 0) {
        appendLog('âœ… æ²’æœ‰å¾…ä¸Šå‚³è³‡æ–™ã€‚');
        return; 
    }
    
    if(!navigator.onLine){ appendLog('é›¢ç·šï¼Œæš«ä¸é€å‡º'); return; }
    
    sending = true;
    
    // å¾å¸¶æœ‰ç´¢å¼•çš„å¾…ä¸Šå‚³æ¸…å–®ä¸­å– batch æ‰¹æ¬¡
    const batchEntries = indexedPending.slice(0, BATCH_SIZE); 
    
    // æº–å‚™å‚³é€åˆ°å¾Œç«¯çš„æ•¸æ“š (åªåŒ…å« item)
    const batchToSend = batchEntries.map(entry => entry.item);

    try{
        const resp = await fetch(GAS_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain'},
        // å‚³é€æ­£ç¢ºçš„ batchToSend
        body: JSON.stringify({ records: batchToSend, api_key: API_KEY || '' })
    });
    
    // ã€æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼ã€‘
    if (!resp.ok) {
        const errorText = await resp.text();
        throw new Error(`HTTP éŒ¯èª¤: ${resp.status} - ${errorText.substring(0, 50)}`);
    }

    const j = await resp.json();
    if(j.status === 'ok'){
        
        // ã€ä½¿ç”¨ç´¢å¼•ç›´æ¥åœ¨åŸ buffer ä¸Šæ¨™è¨˜ sent=trueã€‘
        batchEntries.forEach(entry => {
            buffer[entry.index].sent = true;
        });
        
        saveLocalBuffer();
    
        const remainingToUpload = buffer.filter(item => !item.sent).length; 
        // ä¿®æ­£æ—¥èªŒï¼Œä½¿ç”¨ batchToSend.length é¡¯ç¤ºæˆåŠŸä¸Šå‚³ç­†æ•¸
        appendLog(`âœ… ä¸Šå‚³æˆåŠŸ ${batchToSend.length} ç­†, å‰©é¤˜å¾…ä¸Šå‚³: ${remainingToUpload} ç­† (ç¸½ç´€éŒ„æ•¸: ${buffer.length})`);
        
        updateScanList();

        // ã€é€£ç™¼æ©Ÿåˆ¶ã€‘
        if (remainingToUpload > 0) {
            setTimeout(sendBatch, 0); 
        }
        
        } else {
        appendLog('å¾Œç«¯å›å‚³éŒ¯èª¤: '+JSON.stringify(j));
    }
    }catch(err){
        appendLog(`ğŸ”´ ä¸Šå‚³å¤±æ•—ï¼Œç¨å¾Œé‡è©¦ã€‚éŒ¯èª¤é¡å‹: ${err.name} - ${err.message}`); 
        console.error(err); 
    } finally {
        // ç¢ºä¿ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œä¸Šå‚³ç‹€æ…‹æ——æ¨™éƒ½è¢«é‡ç½®
        sending = false;
    }
}

function startBatchTimer(){
stopBatchTimer();
timerId = setInterval(()=>{ sendBatch(); }, BATCH_TIMEOUT_MS);
}
function stopBatchTimer(){ if(timerId) clearInterval(timerId); timerId=null; }

// ã€æ–°å¢å‡½å¼ã€‘ å¾ GAS ç²å–å°ˆè»Šæ¸…å–®
async function loadTrucks() {
    appendLog('å˜—è©¦è¼‰å…¥å°ˆè»Šæ¸…å–®...');
    try {
        const truckEndpoint = GAS_ENDPOINT + '?action=getTrucks';
        const resp = await fetch(truckEndpoint);
        if (!resp.ok) {
            throw new Error(`HTTP éŒ¯èª¤: ${resp.status}`);
        }
        const j = await resp.json();
        
        whTruckNumberSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡å°ˆè»Š --</option>';

        if (j.status === 'ok' && j.trucks && j.trucks.length > 0) {
            j.trucks.forEach(truck => {
                const option = document.createElement('option');
                option.value = truck;
                option.textContent = truck;
                whTruckNumberSelect.appendChild(option);
            });
            appendLog(`æˆåŠŸè¼‰å…¥ ${j.trucks.length} å€‹å°ˆè»Šç·¨è™Ÿ`);
        } else {
            appendLog('å°ˆè»Šæ¸…å–®è¼‰å…¥å¤±æ•—æˆ–ç‚ºç©º: ' + (j.message || 'è«‹ç¢ºèª GAS è¨­ç½®'));
        }
    } catch (err) {
        appendLog('è¼‰å…¥å°ˆè»Šæ¸…å–®æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤');
        console.error(err);
        whTruckNumberSelect.innerHTML = '<option value="">-- è¼‰å…¥éŒ¯èª¤ --</option>';
    }
}

// ã€æ–°å¢å‡½å¼ã€‘ å¾ GAS ç²å–è³£å®¶æ¸…å–®ä¸¦å¡«å……ä¸‹æ‹‰é¸å–®
async function loadSellers(truckNumber) { 
    // appendLog('å˜—è©¦è¼‰å…¥è³£å®¶æ¸…å–®...');
    sellerSelect.innerHTML = '<option value="">-- è¼‰å…¥ä¸­... --</option>';
    appendLog(`å˜—è©¦è¼‰å…¥å°ˆè»Š [${truckNumber}] çš„è³£å®¶æ¸…å–®...`);
    try {
        const sellerEndpoint = `${GAS_ENDPOINT}?action=getSellers&truck=${encodeURIComponent(truckNumber)}`;
        const resp = await fetch(sellerEndpoint);
        
        if (!resp.ok) {
            throw new Error(`HTTP éŒ¯èª¤: ${resp.status}`);
        }
        
        const j = await resp.json();
        
        // æ¸…ç©ºä¸‹æ‹‰é¸å–®
        sellerSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡è³£å®¶ --</option>'; 

        if (j.status === 'ok' && j.sellers && j.sellers.length > 0) {
            j.sellers.forEach(seller => { // éæ­·è®Šæ•¸åç¨±ä¿®æ”¹
                const option = document.createElement('option');
                option.value = seller;
                option.textContent = seller;
                sellerSelect.appendChild(option);
            });
            appendLog(`å°ˆè»Š [${truckNumber}] æˆåŠŸè¼‰å…¥ ${j.sellers.length} å€‹è³£å®¶`);
        } else {
            // å¦‚æœæ¸…å–®ç‚ºç©ºæˆ–éŒ¯èª¤
            appendLog('è³£å®¶æ¸…å–®è¼‰å…¥å¤±æ•—æˆ–ç‚ºç©º: ' + (j.message || 'è«‹ç¢ºèª GAS è¨­ç½®'));
        }
    } catch (err) {
        appendLog('è¼‰å…¥è³£å®¶æ¸…å–®æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤');
        console.error(err);
        sellerSelect.innerHTML = '<option value="">-- è¼‰å…¥éŒ¯èª¤ --</option>'; 
    }
}

btnStartCamera.addEventListener('click', ()=>{
    // å¿…é ˆåŒæ™‚é¸æ“‡ å°ˆè»Šç·¨è™Ÿ ä¸”é¸æ“‡ Seller
    // if(!whTruckNumberSelect.value){Â 
    // Â  Â  alert('è«‹é¸æ“‡å°ˆè»Šç·¨è™Ÿ (Truck)');Â 
    // Â  Â  return;Â 
    // }
    // if(!sellerSelect.value){Â 
    // Â  Â  alert('è«‹é¸æ“‡è³£å®¶ Seller');Â 
    // Â  Â  return;Â 
    // }
    
    // ã€æ–°å¢ã€‘æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•æ–¼åˆ·æ§æ¨¡å¼ï¼Œå¦‚æœæ˜¯ï¼Œå…ˆåœæ­¢
        if (isScannerMode) {
            // å‘¼å«åœæ­¢å‡½å¼ä¾†é—œé–‰åˆ·æ§æ¨¡å¼
            stopScannerMode(); 
        }
    
    // ã€æ–°å¢ã€‘åœ¨ç”¨æˆ¶é»æ“Šæ™‚åˆå§‹åŒ– Audio Context
    initAudioContext(); // <-- åœ¨é€™è£¡å‘¼å«
        
    if(html5QrScanner) return; // ç›¸æ©Ÿå·²ç¶“å•Ÿå‹•å‰‡é€€å‡º
        
    html5QrScanner = new Html5Qrcode("qr-reader");
    html5QrScanner.start({ facingMode: 'environment' }, {
        fps: 10,
        qrbox: {width:250, height:250}
    }, (decodedText, decodedResult)=>{
        statusEl.textContent = 'æƒåˆ°: '+decodedText;
        enqueue(decodedText);
    }, (errorMessage) => {
        // parse errors or no result
    }).then(()=>{
        appendLog('ç›¸æ©Ÿå•Ÿå‹•'); 
        statusEl.textContent='æƒæä¸­...';
        isScanning = true; // ã€ä¿®æ”¹é»ã€‘å•Ÿå‹•æƒæ
        btnSync.disabled = true; // ã€ä¿®æ”¹é»ã€‘æƒæå•Ÿå‹•æ™‚ç¦ç”¨ä¸Šå‚³
    }).catch(err=>{ alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: '+err); });
    
    
    startBatchTimer();
});

// ã€æ–°å¢ã€‘å•Ÿå‹•åˆ·æ§æƒææŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
btnStartScanner.addEventListener('click', ()=>{
    if(!whTruckNumberSelect.value){ alert('è«‹é¸æ“‡å°ˆè»Šç·¨è™Ÿ'); return; }
    if(!sellerSelect.value){ alert('è«‹é¸æ“‡è³£å®¶ Seller'); return; }
    
    // ã€æ–°å¢ã€‘æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•æ–¼ç›¸æ©Ÿæ¨¡å¼ï¼Œå¦‚æœæ˜¯ï¼Œå…ˆåœæ­¢
    if (isScanning) {
        // å‘¼å«åœæ­¢å‡½å¼ä¾†é—œé–‰ç›¸æ©Ÿæ¨¡å¼
        btnStop.click(); // æ¨¡æ“¬é»æ“Šåœæ­¢æŒ‰éˆ•
    }

    // ã€æ–°å¢ã€‘åœ¨ç”¨æˆ¶é»æ“Šæ™‚åˆå§‹åŒ– Audio Context
    initAudioContext(); // <-- åœ¨é€™è£¡å‘¼å«
    if (isScannerMode) return; // å·²ç¶“å•Ÿå‹•å‰‡é€€å‡º
    
    // å•Ÿç”¨åˆ·æ§æ¨¡å¼
    startScannerMode();
});

btnStop.addEventListener('click', ()=>{
    if(html5QrScanner){
        html5QrScanner.stop().then(()=>{
            html5QrScanner.clear(); 
            html5QrScanner=null; 
            appendLog('ç›¸æ©Ÿå·²åœæ­¢'); 
            statusEl.textContent='å·²åœæ­¢';
            isScanning = false; // ã€ä¿®æ”¹é»ã€‘åœæ­¢æƒæ
            btnSync.disabled = false; // ã€ä¿®æ”¹é»ã€‘åœæ­¢å¾Œå•Ÿç”¨ä¸Šå‚³
        }).catch(e=>console.error(e)); 
    }
    // åœæ­¢åˆ·æ§æ¨¡å¼
    if (isScannerMode) {
        // stopScannerMode();
        // åœæ­¢åˆ·æ§æ¨¡å¼ (é‚è¼¯å±•é–‹ï¼Œç¢ºä¿åŸ·è¡Œ)
        isScannerMode = false;
        btnSync.disabled = false;
        document.removeEventListener('keydown', handleScannerInput);
        scannerBuffer = '';
        if (scannerTimer) clearTimeout(scannerTimer);
        appendLog('åˆ·æ§æƒææ¨¡å¼å¼·åˆ¶åœæ­¢å®Œæˆ');
    }
    
    stopBatchTimer();
    
    // å¦‚æœç›¸æ©Ÿå’Œåˆ·æ§éƒ½æ²’æœ‰å•Ÿå‹•ï¼Œç¢ºä¿ç‹€æ…‹æ­£ç¢º
    if (!isScanning && !isScannerMode) {
        statusEl.textContent = 'å·²åœæ­¢';
    }
});

// ã€æ–°å¢å…©å€‹è¼”åŠ©å‡½å¼ã€‘
function startScannerMode() {
    isScannerMode = true;
    btnSync.disabled = true; // åˆ·æ§æ¨¡å¼ä¸‹ç¦ç”¨ç«‹å³ä¸Šå‚³

    // ã€æ ¸å¿ƒä¿®æ­£ã€‘å»ºç«‹éš±è—è¼¸å…¥æ¡†æ¥æ”¶åˆ·æ§è¼¸å…¥
    if (!scannerInputField) {
        scannerInputField = document.createElement('input');
        scannerInputField.type = 'text';
        scannerInputField.id = 'hiddenScannerInput';
        scannerInputField.autocomplete = 'off';
        scannerInputField.autocorrect = 'off';
        scannerInputField.autocapitalize = 'off';
        scannerInputField.spellcheck = false;
        scannerInputField.inputMode = 'none'; // ä¸é¡¯ç¤ºéµç›¤
        scannerInputField.style.cssText = `
            position: fixed;
            top: -100px;
            left: -100px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        `;
        document.body.appendChild(scannerInputField);
    
    // // ç›£è½å…¨å±€çš„éµç›¤è¼¸å…¥
    // document.addEventListener('keydown', handleScannerInput);
    
    // statusEl.textContent = 'æƒæä¸­ (åˆ·æ§)...'; // å€åˆ†æ¨¡å¼
    // appendLog('åˆ·æ§æƒææ¨¡å¼å•Ÿå‹•');
    // startBatchTimer(); // å•Ÿå‹•è‡ªå‹•ä¸Šå‚³

    // ç›£è½ input äº‹ä»¶ï¼ˆæ¥æ”¶å®Œæ•´è¼¸å…¥ï¼‰
        scannerInputField.addEventListener('input', (e) => {
            const value = e.target.value;

            // ã€æ–°å¢é™¤éŒ¯ã€‘è¨˜éŒ„æ¯æ¬¡è¼¸å…¥äº‹ä»¶
            appendLog(`ğŸ” [åˆ·æ§è¼¸å…¥] ç•¶å‰å€¼: "${value}" (é•·åº¦: ${value.length})`);
            
            if (scannerTimer) clearTimeout(scannerTimer);
            
            scannerTimer = setTimeout(() => {
                const code = scannerInputField.value.trim();
                appendLog(`â±ï¸ [åˆ·æ§è¶…æ™‚è§¸ç™¼] æœ€çµ‚å€¼: "${code}" (é•·åº¦: ${code.length})`);
                if (code) {
                    statusEl.textContent = 'æƒåˆ°: ' + code;
                    enqueue(code);
                    appendLog(`âœ… [åˆ·æ§æˆåŠŸ] ${code}`);
                } else {
                    appendLog(`âš ï¸ [åˆ·æ§å¤±æ•—] è¼¸å…¥æ¡†ç‚ºç©ºæˆ–åƒ…æœ‰ç©ºç™½`);
                }
                scannerInputField.value = '';

            }, SCANNER_TIMEOUT_MS);
        });
        
        // ç›£è½ Enter éµï¼ˆç«‹å³è™•ç†ï¼‰
        scannerInputField.addEventListener('keydown', (e) => {
            // ã€æ–°å¢é™¤éŒ¯ã€‘è¨˜éŒ„æ‰€æœ‰æŒ‰éµ
            appendLog(`âŒ¨ï¸ [æŒ‰éµåµæ¸¬] Key: "${e.key}", Code: "${e.code}", è¼¸å…¥æ¡†å€¼: "${scannerInputField.value}"`);
            
        //     if (e.key === 'Enter') {
        //         e.preventDefault();
        //         if (scannerTimer) clearTimeout(scannerTimer);
                
        //         const code = scannerInputField.value.trim();
        //         appendLog(`â†µ [Enter è§¸ç™¼] æœ€çµ‚å€¼: "${code}" (é•·åº¦: ${code.length})`);
        //         if (code) {
        //             statusEl.textContent = 'æƒåˆ°: ' + code;
        //             enqueue(code);
        //             appendLog(`âœ… [åˆ·æ§æˆåŠŸ via Enter] ${code}`);
        //         } else {
        //             appendLog(`âš ï¸ [Enter ä½†ç„¡æ•¸æ“š] è¼¸å…¥æ¡†ç‚ºç©º`);
        //         }
        //         scannerInputField.value = '';
        //     }
        // });

            // ç§»é™¤ if (e.key === 'Enter') å…§çš„çµç®—é‚è¼¯
        if (e.key === 'Enter') {
            e.preventDefault();
            
            // âŒ ç§»é™¤é€™è£¡æ‰€æœ‰çš„ clearTimeout(scannerTimer); å’Œ enqueue(code); é‚è¼¯
            
            // ã€æ–°å¢ Logã€‘ç¢ºèª Enter æœ‰è¢«æ¥æ”¶ï¼Œä½†äº¤çµ¦è¶…æ™‚è™•ç†
            appendLog(`â†µ [Enter åµæ¸¬] æ¥æ”¶åˆ° Enterï¼Œå°‡äº¤ç”± input è¶…æ™‚æ©Ÿåˆ¶è™•ç†ã€‚`); 
            
            // â—ï¸ é—œéµï¼šç‚ºäº†é¿å… enter çµæŸå¾Œå†æ¬¡è§¸ç™¼è¶…æ™‚ï¼Œå¯ä»¥åŸ·è¡Œä»¥ä¸‹æ“ä½œ
            // è®“ Enter è§¸ç™¼ input äº‹ä»¶çš„è¶…æ™‚é‚è¼¯ç«‹å³é‹è¡Œï¼š
            if (scannerTimer) clearTimeout(scannerTimer);
            
            // ç«‹å³è§¸ç™¼ä¸€å€‹è¶…æ™‚çµç®—ï¼Œå–ä»£èˆŠçš„é‚è¼¯
            setTimeout(() => {
                // é€™æ®µé‚è¼¯èˆ‡ input ç›£è½å™¨ä¸­çš„è¶…æ™‚é‚è¼¯ç›¸åŒ
                const code = scannerInputField.value.trim();
                appendLog(`â±ï¸ [Enter å¾Œç«‹å³çµç®—] æœ€çµ‚å€¼: "${code}"`);
                if (code) {
                    statusEl.textContent = 'æƒåˆ°: ' + code;
                    enqueue(code);
                    appendLog(`âœ… [åˆ·æ§æˆåŠŸ via Enter Timeout] ${code}`);
                } else {
                     appendLog(`âš ï¸ [Enter å¾Œç„¡æ•¸æ“š] å¿½ç•¥`);
                }
                scannerInputField.value = '';
            }, 5); // æ¥µçŸ­å»¶é²ç¢ºä¿è¼¸å…¥æ³•å®Œæˆå¯«å…¥
        }
        // å¦å‰‡ï¼Œä¸åšä»»ä½•å‹•ä½œï¼Œè®“è¼¸å…¥æ³•åœ¨èƒŒæ™¯è‡ªè¡Œè™•ç†
    });
    }
    
    // èšç„¦åˆ°éš±è—è¼¸å…¥æ¡†
    scannerInputField.focus();
    appendLog(`ğŸ¯ [èšç„¦ç‹€æ…‹] è¼¸å…¥æ¡†å·²èšç„¦: ${document.activeElement === scannerInputField}`);
    
    // æ¯éš”ä¸€æ®µæ™‚é–“é‡æ–°èšç„¦ï¼ˆé˜²æ­¢å¤±ç„¦ï¼‰
    const focusInterval = setInterval(() => {
        if (!isScannerMode) {
            clearInterval(focusInterval);
            return;
        }
       if (document.activeElement !== scannerInputField) {
            appendLog(`âš ï¸ [å¤±ç„¦åµæ¸¬] é‡æ–°èšç„¦è¼¸å…¥æ¡†`);
            scannerInputField.focus();
        }
    }, 1000);
    
    statusEl.textContent = 'æƒæä¸­ (åˆ·æ§)...';
    appendLog('ğŸ”« åˆ·æ§æ¨¡å¼å•Ÿå‹• - è«‹ä½¿ç”¨åˆ·æ§æƒæ');
    startBatchTimer();
}

function stopScannerMode() {
    isScannerMode = false;
    btnSync.disabled = false; // æ¢å¾©ç«‹å³ä¸Šå‚³
    
    // ç§»é™¤éµç›¤ç›£è½å™¨
    // document.removeEventListener('keydown', handleScannerInput);

    // ç§»é™¤éš±è—è¼¸å…¥æ¡†
    if (scannerInputField) {
        scannerInputField.remove();
        scannerInputField = null;
    }
    
    // æ¸…ç†åˆ·æ§ç·©è¡å€å’Œè¨ˆæ™‚å™¨
    scannerBuffer = '';
    if (scannerTimer) clearTimeout(scannerTimer);
    
    appendLog('åˆ·æ§æƒææ¨¡å¼åœæ­¢');
}
    
btnSync.addEventListener('click', ()=>{ 
    // ã€ä¿®æ”¹é»ã€‘å¦‚æœæ­£åœ¨æƒæï¼Œå½ˆå‡ºè­¦å‘Šä¸¦è¿”å›
    if(isScanning){
        alert('è«‹å…ˆé»æ“Šã€Œåœæ­¢ã€æŒ‰éˆ•çµæŸæƒæä½œæ¥­ï¼');
        return;
    }
    sendBatch();
});

// ã€æ–°å¢äº‹ä»¶ï¼šé¸æ“‡å°ˆè»Šç·¨è™Ÿå¾Œï¼Œè‡ªå‹•è¼‰å…¥è³£å®¶æ¸…å–®ã€‘
whTruckNumberSelect.addEventListener('change', () => {
    const selectedTruck = whTruckNumberSelect.value;
    if (selectedTruck) {
        // æ¸…ç©º sellerSelectï¼Œä¸¦è§¸ç™¼ loadSellers
        sellerSelect.innerHTML = '<option value="">-- è¼‰å…¥ä¸­... --</option>';
        loadSellers(selectedTruck);
    } else {
        sellerSelect.innerHTML = '<option value="">-- è«‹å…ˆé¸æ“‡å°ˆè»Š --</option>';
    }
    // æ­¤å¤–ï¼Œåˆ‡æ›å°ˆè»Š/è³£å®¶æ™‚æ¸…ç©º buffer çš„é‚è¼¯ä¹Ÿæ‡‰åœ¨é€™è£¡è§¸ç™¼
    if (buffer.length > 0) {
        // è§¸ç™¼åˆ‡æ›è³£å®¶æ¸…ç©ºè³‡æ–™çš„é‚è¼¯
        sellerSelect.dispatchEvent(new Event('change')); 
    }
});


// åˆå§‹è¼‰å…¥ï¼š
loadLocalBuffer(); // æ¢å¾©é›¢ç·šç·©å­˜
loadTrucks(); // âœ… ä¿®æ­£ï¼šå…ˆè¼‰å…¥å°ˆè»Šæ¸…å–®
// loadSellers(); // è¼‰å…¥è³£å®¶æ¸…å–®
// è‡ªå‹•é‡è©¦ä¸Šå‚³(ç¶²è·¯å¾©åŸæ™‚)
window.addEventListener('online', ()=>{ appendLog('ç¶²è·¯å›å¾©ï¼Œé–‹å§‹ä¸Šå‚³'); sendBatch(); });
// ã€ä¿®æ­£å€åŸŸ 2: æ–°å¢è³£å®¶åˆ‡æ›äº‹ä»¶ï¼Œæ¸…ç©ºè³‡æ–™ã€‘
sellerSelect.addEventListener('change', () => {
    // æª¢æŸ¥ç•¶å‰æ˜¯å¦æœ‰å·²è¨˜éŒ„çš„è³‡æ–™ï¼Œé¿å…åœ¨å•Ÿå‹•é é¢æ™‚åŸ·è¡Œæ¸…ç©ºå‹•ä½œ
    if (buffer.length > 0) {
        // 1. æ¸…ç©º buffer (è¨˜æ†¶é«”ä¸­çš„æƒæç´€éŒ„)
        buffer = []; 
        
        // 2. æ¸…ç©ºæœ¬åœ°å„²å­˜ (é›¢ç·šç·©å­˜)
        localStorage.removeItem(LOCAL_KEY);
        
        // 3. ç«‹å³æ›´æ–°è¡¨æ ¼å’Œè¨ˆæ•¸å™¨ï¼Œè®“é é¢æ­¸é›¶
        updateScanList();
        
        appendLog('ğŸ”„ è³£å®¶åˆ‡æ›å®Œæˆï¼Œæƒæç´€éŒ„å·²æ¸…ç©ºã€‚è«‹é–‹å§‹æƒææ–°çš„æ‰¹æ¬¡ã€‚');
        
        // 4. åœæ­¢è‡ªå‹•æ‰¹æ¬¡ä¸Šå‚³è¨ˆæ™‚å™¨
        stopBatchTimer(); 
        
        // 5. åœæ­¢æƒæä¸­çš„ç›¸æ©Ÿ (å»ºè­°æ“ä½œï¼Œç¢ºä¿é‚è¼¯æ¸…æ™°)
        if (html5QrScanner) {
            html5QrScanner.stop().then(() => {
                html5QrScanner.clear();
                html5QrScanner = null;
                appendLog('ç›¸æ©Ÿå·²è‡ªå‹•åœæ­¢ (åˆ‡æ›ä½œæ¥­)ã€‚');
                statusEl.textContent = 'å·²åœæ­¢ (åˆ‡æ›ä½œæ¥­)';
                isScanning = false;
                btnSync.disabled = false;
            }).catch(e => console.error(e));
        } else {
            // å¦‚æœç›¸æ©Ÿæ²’é–‹ï¼Œç¢ºä¿ä¸Šå‚³æŒ‰éˆ•å¯ç”¨
            btnSync.disabled = false;
        }
        // ã€æ–°å¢ã€‘åœæ­¢åˆ·æ§æ¨¡å¼
        if (isScannerMode) {
            stopScannerMode();
            statusEl.textContent = 'å·²åœæ­¢ (åˆ‡æ›ä½œæ¥­)';
        }
    }
});
</script>
</body>
</html>
