<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ¥Šæ¢…æƒç®±ç³»çµ±</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body{font-family:system-ui, -apple-system, 'Noto Sans TC', sans-serif; padding:12px}
#controls{display:flex; gap:8px; margin-bottom:8px}
#log{white-space:pre-wrap; max-height:200px; overflow:auto; background:#f7f7f7; padding:8px}
button{padding:8px 12px; cursor: pointer;}
</style>
</head>
<body>
<h2>æ¥Šæ¢…æƒç®±ç³»çµ±</h2>

<div id="controls">
<button id="btnStartCamera">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
<button id="btnStop">åœæ­¢</button>
<button id="btnSync">ç«‹å³ä¸Šå‚³</button>
</div>

<div id="qr-reader" style="width:100%; max-width:480px; margin-bottom:8px"></div>
<div id="status">å°šæœªé–‹å§‹æƒæ</div>
<h4>
    æƒæç´€éŒ„ï¼ˆsessionï¼‰
    <span style="font-size: 0.7em; color: #666;">
        [è«‹å¾…è³‡æ–™éƒ½ä¸Šå‚³å¾Œå†æŒ‰ä¸‹[åœæ­¢]æŒ‰éˆ•ï¼Œè¬è¬!]
    </span>
</h4>
<h4>
    ç¸½è¨ˆæƒæï¼š<span id="totalCount">0</span> ç­† | 
    å·²ä¸Šå‚³ï¼š<span id="uploadedCount">0</span> ç­† |
    å¾…ä¸Šå‚³ï¼š<span id="pendingCount">0</span> ç­†
</h4>
<table id="scanTable" style="width:100%; border-collapse: collapse; margin-bottom: 12px; border: 1px solid #ccc;">
    <thead>
        <tr style="background: #e7e7e7;">
            <th style="padding: 4px; border: 1px solid #ccc;">#</th>
            <th style="padding: 4px; border: 1px solid #ccc;">æƒæç·¨è™Ÿ (QR Code)</th>
            <th style="padding: 4px; border: 1px solid #ccc;">æ™‚é–“æˆ³</th> 
            <th style="padding: 4px; border: 1px solid #ccc;">ç‹€æ…‹</th> </tr>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
<div id="log"></div>

<script src="config.js"></script>
<script>
// ====================================================================
// ã€é…ç½®è®Šæ•¸å®‰å…¨é è¨­å€¼ã€‘
// å‡è¨­ config.js å­˜åœ¨ä¸¦å®šç¾©äº†ä»¥ä¸‹è®Šæ•¸ã€‚è‹¥ç„¡ï¼Œä½¿ç”¨é è¨­å€¼é¿å…éŒ¯èª¤ã€‚
// è«‹å°‡é€™äº›é è¨­å€¼æ›¿æ›æˆæ‚¨å¯¦éš›çš„å€¼
const GAS_ENDPOINT = window.GAS_ENDPOINT || 'YOUR_GOOGLE_APP_SCRIPT_URL_HERE'; 
const BATCH_SIZE = window.BATCH_SIZE || 10;
const BATCH_TIMEOUT_MS = window.BATCH_TIMEOUT_MS || 5000;
const API_KEY = window.API_KEY || 'YOUR_API_KEY_HERE';
// ====================================================================

// DOM å…ƒç´ 
const btnStartCamera = document.getElementById('btnStartCamera');
const btnStop = document.getElementById('btnStop');
const btnSync = document.getElementById('btnSync');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const totalCountEl = document.getElementById('totalCount');
const scanTableBody = document.querySelector('#scanTable tbody');
const uploadedCountEl = document.getElementById('uploadedCount'); 
const pendingCountEl = document.getElementById('pendingCount');

// æƒæ/ç·©å­˜è®Šæ•¸
const LOCAL_KEY = 'qr_scan_offline_buffer_v1_simple';
let html5QrScanner = null;
let isScanning = false;
let audioContext = null;
let buffer = []; // æœªé€å‡ºçš„æƒæè³‡æ–™
let sending = false;
let timerId = null;


// ====================================================================
// æ ¸å¿ƒå‡½å¼
// ====================================================================

/**
 * æ›´æ–°æƒæç´€éŒ„åˆ—è¡¨å’Œè¨ˆæ•¸å™¨
 */
function updateScanList(){
    let uploadedCount = 0;
    totalCountEl.textContent = buffer.length;
    scanTableBody.innerHTML = ''; 
    
    // éæ­· bufferï¼Œå¾æœ€æ–°æƒæçš„é–‹å§‹é¡¯ç¤º (åå‘)
    for(let i = buffer.length - 1; i >= 0; i--){
        const item = buffer[i];
        const row = scanTableBody.insertRow();
        row.insertCell().textContent = i + 1; // åºè™Ÿ
        row.insertCell().textContent = item.code; // QR Code ç·¨è™Ÿ
        row.insertCell().textContent = item.ts; // æ™‚é–“æˆ³
        
        const statusCell = row.insertCell();

        if(item.sent){
            row.style.backgroundColor = '#d4edda'; // æ·ºç¶ è‰²èƒŒæ™¯
            statusCell.textContent = 'âœ… å·²ä¸Šå‚³';
            uploadedCount++;
        } else {
            statusCell.textContent = 'â³ å¾…ä¸Šå‚³';
        }
    }
    
    uploadedCountEl.textContent = uploadedCount;
    pendingCountEl.textContent = buffer.length - uploadedCount;
}
    
/**
 * è¼‰å…¥æœ¬åœ°ç·©å­˜
 */
function loadLocalBuffer(){
    try{
        const raw = localStorage.getItem(LOCAL_KEY);
        if(raw){ 
            buffer = JSON.parse(raw); 
            appendLog(`å¾ localStorage è¼‰å…¥ ${buffer.length} ç­†`); 
        }
    }catch(e){ console.error(e);} 
    updateScanList(); 
}
    
/**
 * å„²å­˜æœ¬åœ°ç·©å­˜
 */
function saveLocalBuffer(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(buffer)); }

/**
 * æ–°å¢æ—¥èªŒè¨Šæ¯
 */
function appendLog(text){
    let safeText = String(text);
    if (safeText.includes('<html') || safeText.includes('<body') || safeText.length > 500) {
        safeText = safeText.substring(0, 500) + '... (è¼‰å…¥éŒ¯èª¤è¨Šæ¯éé•·æˆ–åŒ…å« HTML å·²æˆªæ–·)';
    }
    logEl.textContent = new Date().toLocaleTimeString('zh-TW') + ' - ' + safeText + '\n' + logEl.textContent;
}

/**
 * åˆå§‹åŒ– Web Audio API Context
 */
function initAudioContext() {
    if (audioContext) return;
    try {
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContextClass();
    } catch (e) {
        console.warn("ç„¡æ³•åˆå§‹åŒ– AudioContext:", e);
    }
}

/**
 * æ’­æ”¾ Beep è²éŸ³
 */
function playBeep() {
    if (!audioContext) {
        initAudioContext();
        if (!audioContext) return;
    }
    
    const duration = 0.1;
    const frequency = 880;
    const volume = 0.5;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.type = 'square';
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    oscillator.start();
    oscillator.stop(audioContext.currentTime + duration);
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
}

/**
 * å°‡æƒæåˆ°çš„ä»£ç¢¼åŠ å…¥éšŠåˆ— (Buffer)
 * @param {string} code - æƒæåˆ°çš„ QR Code æˆ–æ¢ç¢¼
 */
function enqueue(code){
    playBeep();
    
    // æª¢æŸ¥æ˜¯å¦é‡è¤‡æƒæ (åœ¨æ•´å€‹æ­·å²ç´€éŒ„ä¸­)
    const isDuplicate = buffer.some(item => item.code === code); 
    
    if(isDuplicate){
        appendLog(`âš ï¸ å¿½ç•¥é‡è¤‡æƒæ: ${code} (å·²åœ¨æ­·å²ç´€éŒ„ä¸­)`); 
        return; 
    }
    
    const now = new Date();
    // æ ¼å¼åŒ–æ™‚é–“æˆ³ç‚ºå°ç£æœ¬åœ°æ™‚å€å­—ä¸²
    const localTimeString = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false, 
        timeZone: 'Asia/Taipei'
    });
    
    const item = {
        code: code,
        // ç§»é™¤äº† driver å’Œ seller å±¬æ€§
        ts: localTimeString
    };
    
    buffer.push(item);
    saveLocalBuffer();
    appendLog(`ğŸŸ¢ æƒåˆ°: ${code}`);
    
    updateScanList();
    
    // æª¢æŸ¥æ˜¯å¦é”åˆ°æ‰¹æ¬¡å¤§å°ï¼Œä¸¦è§¸ç™¼ä¸Šå‚³
    if(buffer.length >= BATCH_SIZE) sendBatch();
}

/**
 * æ‰¹æ¬¡ä¸Šå‚³å¾…è™•ç†æ•¸æ“šåˆ°å¾Œç«¯ GAS
 */
async function sendBatch(){
    if(sending) return;
    
    const indexedPending = buffer
        .map((item, index) => ({ item, index }))
        .filter(entry => !entry.item.sent);

    if(indexedPending.length === 0) {
        appendLog('âœ… æ²’æœ‰å¾…ä¸Šå‚³è³‡æ–™ã€‚');
        return; 
    }
    
    if(!navigator.onLine){ appendLog('é›¢ç·šï¼Œæš«ä¸é€å‡º'); return; }
    
    sending = true;
    
    const batchEntries = indexedPending.slice(0, BATCH_SIZE); 
    const batchToSend = batchEntries.map(entry => entry.item);

    try{
        const resp = await fetch(GAS_ENDPOINT, {
            method: 'POST',
            // headers: {'Content-Type': 'text/plain'},
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ records: batchToSend, api_key: API_KEY || '' })
        });
        
        if (!resp.ok) {
            const errorText = await resp.text();
            throw new Error(`HTTP éŒ¯èª¤: ${resp.status} - ${errorText.substring(0, 50)}`);
        }

        const j = await resp.json();
        if(j.status === 'ok'){
            batchEntries.forEach(entry => {
                buffer[entry.index].sent = true;
            });
            
            saveLocalBuffer();
            const remainingToUpload = buffer.filter(item => !item.sent).length; 
            appendLog(`âœ… ä¸Šå‚³æˆåŠŸ ${batchToSend.length} ç­†, å‰©é¤˜å¾…ä¸Šå‚³: ${remainingToUpload} ç­†`);
            
            updateScanList();

            // é€£ç™¼æ©Ÿåˆ¶ (åªæœ‰åœ¨å®šæ™‚å™¨å•Ÿå‹•æ™‚æ‰é€£ç™¼ï¼Œä»¥é…åˆ Stop æŒ‰éˆ•)
            if (remainingToUpload > 0 && timerId) { 
                setTimeout(sendBatch, 0); 
            }
            
        } else {
            appendLog('å¾Œç«¯å›å‚³éŒ¯èª¤: '+JSON.stringify(j));
        }
    }catch(err){
        appendLog(`ğŸ”´ ä¸Šå‚³å¤±æ•—ï¼Œç¨å¾Œé‡è©¦ã€‚éŒ¯èª¤é¡å‹: ${err.name} - ${err.message}`); 
        console.error(err); 
    } finally {
        sending = false;
    }
}

/**
 * å•Ÿå‹•æ‰¹æ¬¡ä¸Šå‚³è¨ˆæ™‚å™¨
 */
function startBatchTimer(){
    stopBatchTimer();
    timerId = setInterval(()=>{ sendBatch(); }, BATCH_TIMEOUT_MS);
}

/**
 * åœæ­¢æ‰¹æ¬¡ä¸Šå‚³è¨ˆæ™‚å™¨
 */
function stopBatchTimer(){ 
    if(timerId) clearInterval(timerId); 
    timerId=null; 
}


// ====================================================================
// äº‹ä»¶ç›£è½å™¨
// ====================================================================

btnStartCamera.addEventListener('click', ()=>{
    // ç¢ºä¿åªå•Ÿå‹•ä¸€æ¬¡ Audio Context
    initAudioContext();
        
    if(html5QrScanner) return; // ç›¸æ©Ÿå·²ç¶“å•Ÿå‹•å‰‡é€€å‡º
        
    html5QrScanner = new Html5Qrcode("qr-reader");
    html5QrScanner.start({ facingMode: 'environment' }, {
        fps: 10,
        qrbox: {width:250, height:250}
    }, (decodedText, decodedResult)=>{
        // æƒææˆåŠŸçš„å›èª¿
        statusEl.textContent = 'æƒåˆ°: '+decodedText;
        enqueue(decodedText);
    }, (errorMessage) => {
        // éŒ¯èª¤å›èª¿ (é€šå¸¸æ˜¯æ²’æœ‰çµæœï¼Œå¯å¿½ç•¥)
    }).then(()=>{
        // å•Ÿå‹•æˆåŠŸ
        appendLog('ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ'); 
        statusEl.textContent='æƒæä¸­...';
        isScanning = true;
        btnSync.disabled = true; // æƒæå•Ÿå‹•æ™‚ç¦ç”¨ç«‹å³ä¸Šå‚³
        startBatchTimer();
    }).catch(err=>{ 
        // å•Ÿå‹•å¤±æ•—
        appendLog(`ğŸ”´ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š${err.name || 'Error'}: ${err.message || String(err)}`);
        alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–ç¶²è·¯å”è­° (éœ€ HTTPS)ã€‚è©³è¦‹ä¸‹æ–¹æ—¥èªŒã€‚'); 
        console.error('Camera startup error:', err);
    });
});

btnStop.addEventListener('click', ()=>{
    if(html5QrScanner){
        html5QrScanner.stop().then(()=>{
            html5QrScanner.clear(); 
            html5QrScanner=null; 
            appendLog('ç›¸æ©Ÿå·²åœæ­¢'); 
            statusEl.textContent='å·²åœæ­¢';
            isScanning = false;
            btnSync.disabled = false; // åœæ­¢å¾Œå•Ÿç”¨ç«‹å³ä¸Šå‚³
        }).catch(e=>console.error(e)); 
    } else {
        // å¦‚æœç›¸æ©Ÿæ²’å•Ÿå‹•ï¼Œä¹Ÿç¢ºä¿ç‹€æ…‹æ­£ç¢º
        statusEl.textContent = 'å·²åœæ­¢';
        isScanning = false;
        btnSync.disabled = false;
    }
    
    stopBatchTimer();
});

btnSync.addEventListener('click', ()=>{ 
    if(isScanning){
        alert('è«‹å…ˆé»æ“Šã€Œåœæ­¢ã€æŒ‰éˆ•çµæŸæƒæä½œæ¥­ï¼');
        return;
    }
    sendBatch();
});

// ====================================================================
// åˆå§‹åŒ–
// ====================================================================
loadLocalBuffer(); // æ¢å¾©é›¢ç·šç·©å­˜

// è‡ªå‹•é‡è©¦ä¸Šå‚³(ç¶²è·¯å¾©åŸæ™‚)
window.addEventListener('online', ()=>{ 
    appendLog('ç¶²è·¯å›å¾©ï¼Œé–‹å§‹å˜—è©¦ä¸Šå‚³'); 
    sendBatch(); 
});
</script>
</body>
</html>
