<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æƒç®±ç³»çµ±</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body{font-family:system-ui, -apple-system, 'Noto Sans TC', sans-serif; padding:12px}
#controls{display:flex; gap:8px; margin-bottom:8px}
#log{white-space:pre-wrap; max-height:200px; overflow:auto; background:#f7f7f7; padding:8px}
button{padding:8px 12px}
</style>
</head>
<body>
<h2>æ¥Šæ¢…æƒç®±ç³»çµ±</h2>

<div id="controls">
<button id="btnStartCamera">å•Ÿå‹•ç›¸æ©Ÿæƒæ</button>
<button id="btnStop">åœæ­¢</button>
<button id="btnSync">ç«‹å³ä¸Šå‚³</button>
</div>


<div id="qr-reader" style="width:100%; max-width:480px; margin-bottom:8px"></div>
<div id="status">å°šæœªé–‹å§‹æƒæ</div>
<h4>
    æƒæç´€éŒ„ï¼ˆsessionï¼‰
    <span style="font-size: 0.7em; color: #666;">
        [è«‹å¾…è³‡æ–™éƒ½ä¸Šå‚³å¾Œå†æŒ‰ä¸‹[åœæ­¢]æŒ‰éˆ•ï¼Œè¬è¬!]
    </span>
</h4>
<h4>
    ç¸½è¨ˆæƒæï¼š<span id="totalCount">0</span> ç­† | 
    å·²ä¸Šå‚³ï¼š<span id="uploadedCount">0</span> ç­† |
    å¾…ä¸Šå‚³ï¼š<span id="pendingCount">0</span> ç­†
</h4>
<table id="scanTable" style="width:100%; border-collapse: collapse; margin-bottom: 12px; border: 1px solid #ccc;">
    <thead>
        <tr style="background: #e7e7e7;">
            <th style="padding: 4px; border: 1px solid #ccc;">#</th>
            <th style="padding: 4px; border: 1px solid #ccc;">æƒæç·¨è™Ÿ (QR Code)</th>
            <th style="padding: 4px; border: 1px solid #ccc;">ç‹€æ…‹</th> </tr>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>
<div id="log"></div>

<script src="config.js"></script>
<script>
// CONFIG from config.js: GAS_ENDPOINT, BATCH_SIZE, BATCH_TIMEOUT_MS
// const whTruckNumberSelect = document.getElementById('whTruckNumber'); 
// const sellerSelect = document.getElementById('seller');
// const btnStart = document.getElementById('btnStart');

// è®Šæ›´ï¼šå°‡ btnStart è®Šæ•¸é‡æ–°å‘½åä¸¦æ–°å¢åˆ·æ§æŒ‰éˆ•è®Šæ•¸
const btnStartCamera = document.getElementById('btnStartCamera'); // ğŸ‘ˆ å¾ btnStart è®Šæ›´
// å·²ç§»é™¤ btnStartScanner
const btnStop = document.getElementById('btnStop');
const btnSync = document.getElementById('btnSync');
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');

// æƒæç›¸é—œè®Šæ•¸
const totalCountEl = document.getElementById('totalCount');
const scanTableBody = document.querySelector('#scanTable tbody');

const uploadedCountEl = document.getElementById('uploadedCount'); 
const pendingCountEl = document.getElementById('pendingCount');

// éŸ³æ•ˆç›¸é—œè®Šæ•¸å’Œå‡½å¼ - ä½¿ç”¨ Web Audio API
let audioContext = null;

let html5QrScanner = null;
let isScanning = false; // è¿½è¹¤ç›¸æ©Ÿæƒæç‹€æ…‹
// å·²ç§»é™¤ isScannerMode
    
let buffer = []; // æœªé€å‡ºçš„æƒæè³‡æ–™
let sending = false;
let timerId = null;

// è¼‰å…¥ local cache çš„æœªé€å‡ºè³‡æ–™
const LOCAL_KEY = 'qr_scan_offline_buffer_v1';

function updateScanList(){
    // â¬‡ï¸ ã€ä¿®æ”¹é»ã€‘æ–°å¢è¨ˆæ•¸é‚è¼¯
    let uploadedCount = 0;
    
    // æ›´æ–°ç¸½è¨ˆ
    totalCountEl.textContent = buffer.length;

    // æ¸…ç©ºè¡¨æ ¼
    scanTableBody.innerHTML = ''; 
    
    // éæ­· bufferï¼Œå¾æœ€æ–°æƒæçš„é–‹å§‹é¡¯ç¤º (åå‘)
    for(let i = buffer.length - 1; i >= 0; i--){
        const item = buffer[i];
        const row = scanTableBody.insertRow();
        row.insertCell().textContent = i + 1; // åºè™Ÿ
        // row.insertCell().textContent = item.seller; // è³£å®¶åç¨±
        row.insertCell().textContent = item.code; // QR Code ç·¨è™Ÿ
        // è™•ç† sent ç‹€æ…‹
        const statusCell = row.insertCell();

        if(item.sent){
            row.style.backgroundColor = '#d4edda'; // æ·ºç¶ è‰²èƒŒæ™¯
            statusCell.textContent = 'âœ… å·²ä¸Šå‚³';
            uploadedCount++; // çµ±è¨ˆå·²ä¸Šå‚³ç­†æ•¸
        } else {
            statusCell.textContent = 'â³ å¾…ä¸Šå‚³';
        }
    }
    // â¬‡ï¸ ã€ä¿®æ”¹é»ã€‘æ›´æ–°ä¸‰å€‹è¨ˆæ•¸å™¨
    uploadedCountEl.textContent = uploadedCount;
    pendingCountEl.textContent = buffer.length - uploadedCount;
}
    
function loadLocalBuffer(){
    try{
        const raw = localStorage.getItem(LOCAL_KEY);
        if(raw){ 
            buffer = JSON.parse(raw); 
            appendLog(`å¾ localStorage è¼‰å…¥ ${buffer.length} ç­†`); 
        }
    }catch(e){ console.error(e);} 
    // ã€ä¿®æ”¹é»ã€‘è¼‰å…¥ç·©å­˜å¾Œæ›´æ–°åˆ—è¡¨
    updateScanList(); 
}

    
function saveLocalBuffer(){ localStorage.setItem(LOCAL_KEY, JSON.stringify(buffer)); }


// function appendLog(text){
// logEl.textContent = new Date().toLocaleTimeString() + ' - ' + text + '\n' + logEl.textContent;
// }
// ã€ä¿®æ­£å€åŸŸ 1: ç¢ºä¿æ—¥èªŒè¼¸å‡ºå®‰å…¨ã€‘
function appendLog(text){
    // é™åˆ¶æ—¥èªŒè¨Šæ¯é•·åº¦ï¼Œé¿å…é¡¯ç¤ºå®Œæ•´çš„ HTML éŒ¯èª¤é é¢
    let safeText = String(text);
    
    // æª¢æŸ¥è¨Šæ¯æ˜¯å¦åƒæ˜¯ HTML å…§å®¹ (ä¾‹å¦‚åŒ…å« <html æˆ– <body ç­‰) æˆ–è¨Šæ¯éé•·ï¼Œé€²è¡Œæˆªæ–·
    if (safeText.includes('<html') || safeText.includes('<body') || safeText.length > 500) {
        safeText = safeText.substring(0, 500) + '... (è¼‰å…¥éŒ¯èª¤è¨Šæ¯éé•·æˆ–åŒ…å« HTML å·²æˆªæ–·)';
    }

    logEl.textContent = new Date().toLocaleTimeString() + ' - ' + safeText + '\n' + logEl.textContent;
}

function initAudioContext() {
    if (audioContext) return;
    try {
        // å˜—è©¦å»ºç«‹ AudioContext
        // ç”±æ–¼ç€è¦½å™¨å¯èƒ½éœ€è¦å‰ç¶´ï¼Œé€™è£¡ä½¿ç”¨ window.AudioContext æˆ– window.webkitAudioContext
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContextClass();
        console.log("AudioContext åˆå§‹åŒ–æˆåŠŸ");
    } catch (e) {
        console.warn("ç„¡æ³•åˆå§‹åŒ– AudioContext:", e);
    }
}

// ä½¿ç”¨ Web Audio API ç”Ÿæˆä¸€å€‹çŸ­ä¿ƒçš„ Beep è²éŸ³
function playBeep() {
    if (!audioContext) {
        // å¦‚æœ AudioContext å°šæœªåˆå§‹åŒ– (å¯èƒ½å› ç‚ºé¦–æ¬¡æ’­æ”¾è¢«é˜»æ­¢)ï¼Œå‰‡å˜—è©¦åˆå§‹åŒ–
        initAudioContext();
        if (!audioContext) return;
    }
    
    // Web Audio API çš„è²éŸ³ç”Ÿæˆé‚è¼¯
    const duration = 0.1; // è²éŸ³æŒçºŒæ™‚é–“ (ç§’)
    const frequency = 880; // è²éŸ³é »ç‡ (Hz, A5 éŸ³é«˜)
    const volume = 0.5;
    
    // å»ºç«‹éœ‡ç›ªå™¨ (Oscillator)
    const oscillator = audioContext.createOscillator();
    // å»ºç«‹å¢ç›Šç¯€é» (GainNode) ä¾†æ§åˆ¶éŸ³é‡
    const gainNode = audioContext.createGain();

    oscillator.type = 'square'; // æ–¹æ³¢è²éŸ³è¼ƒç‚ºå°–éŠ³ï¼Œé©åˆå—¶å—¶è²
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
    
    // é€£æ¥ç¯€é»: éœ‡ç›ªå™¨ -> å¢ç›Š -> è¼¸å‡º
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    // é–‹å§‹å’ŒçµæŸè²éŸ³
    oscillator.start();
    // è²éŸ³åœ¨ duration æ™‚é–“å¾ŒçµæŸ
    oscillator.stop(audioContext.currentTime + duration);

    // (å¯é¸) åœ¨è²éŸ³çµæŸå¾Œï¼Œå°‡éŸ³é‡å¿«é€Ÿé™ç‚º 0ï¼Œé¿å…çˆ†éŸ³
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
}

// ç§»é™¤èˆŠçš„ playBeep å‡½å¼ (å·²ç”¨ Web Audio API ç‰ˆæœ¬å–ä»£)
// function playBeep() { ... }
    
function enqueue(code){
    // ã€æ–°å¢ã€‘æ’­æ”¾éŸ³æ•ˆ
    playBeep();
    
    // â¬‡ï¸ ã€æ–°å¢ï¼šæª¢æŸ¥æ‰€æœ‰æ­·å²ç´€éŒ„ã€‘
    // ä½¿ç”¨ Array.prototype.some() æª¢æŸ¥ buffer ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç·¨è™Ÿ (code) çš„ç´€éŒ„
    const isDuplicate = buffer.some(item => item.code === code); 
    
    if(isDuplicate){
        // å¦‚æœç™¼ç¾é‡è¤‡ï¼Œå‰‡è¨˜éŒ„æ—¥èªŒä¸¦é€€å‡ºï¼Œä¸å°‡å…¶åŠ å…¥ buffer
        appendLog(`âš ï¸ å¿½ç•¥é‡è¤‡æƒæ: ${code} (å·²åœ¨æ­·å²ç´€éŒ„ä¸­)`); 
        return; 
    }
    // â¬†ï¸ ã€çµæŸï¼šæª¢æŸ¥æ‰€æœ‰æ­·å²ç´€éŒ„ã€‘
    
    const now = new Date(); // å‰µå»º Date ç‰©ä»¶

    // â¬‡ï¸ ã€é—œéµä¿®æ”¹ã€‘å°‡æ™‚é–“æˆ³ç›´æ¥è½‰æ›æˆæœ¬åœ°æ™‚å€å­—ä¸²
    const localTimeString = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false, // 24 å°æ™‚åˆ¶
        timeZone: 'Asia/Taipei' // ç¢ºä¿æ˜¯å°ç£æ™‚é–“
    });
    
    const item = {
        code: code,
        // driver: driverInput.value || 'unknown',
        // â¬‡ï¸ é€™è£¡ä¿®æ”¹ç‚ºå‚³é€å°ˆè»Šç·¨è™Ÿ
        // driver: whTruckNumberSelect.value || 'unknown',
        // seller: sellerSelect.value || '',
        driver: '',    // ç•™ç©º
        seller: '',    // ç•™ç©º
        // â¬‡ï¸ å°‡ ts æ¬„ä½å„²å­˜ç‚ºæœ¬åœ°åŒ–å­—ä¸² (æ‚¨å¸Œæœ›å¯«å…¥ Sheet çš„æ ¼å¼)
        ts: localTimeString
        // ts: new Date().toISOString()
    };
    // simple session dedupe // ç”±æ–¼æˆ‘å€‘å·²ç¶“æª¢æŸ¥äº†æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œä¸éœ€è¦åŸä¾†çš„ "simple session dedupe" æª¢æŸ¥ã€‚
    // const last = buffer[buffer.length-1];
    // if(last && last.code === item.code)
    //      { appendLog('å¿½ç•¥é‡è¤‡æƒæ: '+item.code); 
    //       return; 
    // }
    
    buffer.push(item);
    saveLocalBuffer();
    // appendLog('åŠ å…¥ buffer: '+code+' (buffer='+buffer.length+')'); // èˆŠæ—¥èªŒå¯è¨»è§£æ‰
    appendLog(`ğŸŸ¢ æƒåˆ°: ${code}`); // æ–°æ—¥èªŒé¡¯ç¤º
    
    // ã€ä¿®æ”¹é»ã€‘å‘¼å«æ›´æ–°åˆ—è¡¨
    updateScanList();
    if(buffer.length >= BATCH_SIZE) ();
}

// å·²ç§»é™¤åˆ·æ§æƒæç›¸é—œé‚è¼¯å’Œå‡½å¼ (handleScannerInput, startScannerMode, stopScannerMode)

// ã€æœ€çµ‚ç‰ˆæœ¬ï¼šä¿®å¾©é€£ç™¼ã€æœªå®šç¾©è®Šæ•¸å’Œå‚³é€éŒ¯èª¤ã€‘
async function sendBatch(){
    if(sending) return;
    
    // â¬‡ï¸ ã€æ­¥é©Ÿ 1ï¼šå»ºç«‹åŒ…å«ç´¢å¼•çš„å¾…ä¸Šå‚³æ¸…å–®ã€‘
    const indexedPending = buffer
        .map((item, index) => ({ item, index }))
        .filter(entry => !entry.item.sent);

    // æª¢æŸ¥æ˜¯å¦æœ‰å¾…ä¸Šå‚³è³‡æ–™
    if(indexedPending.length === 0) {
        appendLog('âœ… æ²’æœ‰å¾…ä¸Šå‚³è³‡æ–™ã€‚');
        return; 
    }
    
    if(!navigator.onLine){ appendLog('é›¢ç·šï¼Œæš«ä¸é€å‡º'); return; }
    
    sending = true;
    
    // å¾å¸¶æœ‰ç´¢å¼•çš„å¾…ä¸Šå‚³æ¸…å–®ä¸­å– batch æ‰¹æ¬¡
    const batchEntries = indexedPending.slice(0, BATCH_SIZE); 
    
    // æº–å‚™å‚³é€åˆ°å¾Œç«¯çš„æ•¸æ“š (åªåŒ…å« item)
    const batchToSend = batchEntries.map(entry => entry.item);

    try{
        // âš ï¸ ç¢ºä¿ GAS_ENDPOINT å’Œ API_KEY åœ¨ config.js æˆ–æ­¤è…³æœ¬é ‚éƒ¨æœ‰å®šç¾©
        const resp = await fetch(GAS_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type': 'text/plain'},
        // å‚³é€æ­£ç¢ºçš„ batchToSend
        body: JSON.stringify({ records: batchToSend, api_key: API_KEY || '' })
    });
    
    // ã€æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼ã€‘
    if (!resp.ok) {
        const errorText = await resp.text();
        throw new Error(`HTTP éŒ¯èª¤: ${resp.status} - ${errorText.substring(0, 50)}`);
    }

    const j = await resp.json();
    if(j.status === 'ok'){
        
        // ã€ä½¿ç”¨ç´¢å¼•ç›´æ¥åœ¨åŸ buffer ä¸Šæ¨™è¨˜ sent=trueã€‘
        batchEntries.forEach(entry => {
            buffer[entry.index].sent = true;
        });
        
        saveLocalBuffer();
    
        const remainingToUpload = buffer.filter(item => !item.sent).length; 
        // ä¿®æ­£æ—¥èªŒï¼Œä½¿ç”¨ batchToSend.length é¡¯ç¤ºæˆåŠŸä¸Šå‚³ç­†æ•¸
        appendLog(`âœ… ä¸Šå‚³æˆåŠŸ ${batchToSend.length} ç­†, å‰©é¤˜å¾…ä¸Šå‚³: ${remainingToUpload} ç­† (ç¸½ç´€éŒ„æ•¸: ${buffer.length})`);
        
        updateScanList();

        // ã€é€£ç™¼æ©Ÿåˆ¶ã€‘
        if (remainingToUpload > 0) {
            setTimeout(sendBatch, 0); 
        }
        
        } else {
        appendLog('å¾Œç«¯å›å‚³éŒ¯èª¤: '+JSON.stringify(j));
    }
    }catch(err){
        appendLog(`ğŸ”´ ä¸Šå‚³å¤±æ•—ï¼Œç¨å¾Œé‡è©¦ã€‚éŒ¯èª¤é¡å‹: ${err.name} - ${err.message}`); 
        console.error(err); 
    } finally {
        // ç¢ºä¿ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œä¸Šå‚³ç‹€æ…‹æ——æ¨™éƒ½è¢«é‡ç½®
        sending = false;
    }
}

function startBatchTimer(){
stopBatchTimer();
timerId = setInterval(()=>{ sendBatch(); }, BATCH_TIMEOUT_MS);
}
function stopBatchTimer(){ if(timerId) clearInterval(timerId); timerId=null; }

// ã€ç§»é™¤è¼‰å…¥å°ˆè»Š/è³£å®¶æ¸…å–®å‡½å¼ã€‘
// async function loadTrucks() { ... }
// async function loadSellers(truckNumber) { ... }

btnStartCamera.addEventListener('click', ()=>{
    // å¿…é ˆåŒæ™‚é¸æ“‡ å°ˆè»Šç·¨è™Ÿ ä¸”é¸æ“‡ Seller (å·²è¨»è§£ï¼Œä¿ç•™)
    // if(!whTruckNumberSelect.value){ 
    //      alert('è«‹é¸æ“‡å°ˆè»Šç·¨è™Ÿ (Truck)'); 
    //      return; 
    // }
    // if(!sellerSelect.value){ 
    //      alert('è«‹é¸æ“‡è³£å®¶ Seller'); 
    //      return; 
    // }
    
    // ã€å·²ç§»é™¤æª¢æŸ¥åˆ·æ§æ¨¡å¼çš„é‚è¼¯ã€‘
    
    // ã€æ–°å¢ã€‘åœ¨ç”¨æˆ¶é»æ“Šæ™‚åˆå§‹åŒ– Audio Context
    initAudioContext(); // <-- åœ¨é€™è£¡å‘¼å«
        
    if(html5QrScanner) return; // ç›¸æ©Ÿå·²ç¶“å•Ÿå‹•å‰‡é€€å‡º
        
    html5QrScanner = new Html5Qrcode("qr-reader");
    html5QrScanner.start({ facingMode: 'environment' }, {
        fps: 10,
        qrbox: {width:250, height:250}
    }, (decodedText, decodedResult)=>{
        statusEl.textContent = 'æƒåˆ°: '+decodedText;
        enqueue(decodedText);
    }, (errorMessage) => {
        // parse errors or no result
    }).then(()=>{
        appendLog('ç›¸æ©Ÿå•Ÿå‹•'); 
        statusEl.textContent='æƒæä¸­...';
        isScanning = true; // ã€ä¿®æ”¹é»ã€‘å•Ÿå‹•æƒæ
        btnSync.disabled = true; // ã€ä¿®æ”¹é»ã€‘æƒæå•Ÿå‹•æ™‚ç¦ç”¨ä¸Šå‚³
    }).catch(err=>{ alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: '+err); });
    
    
    startBatchTimer();
});

// ã€å·²ç§»é™¤å•Ÿå‹•åˆ·æ§æƒææŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨ã€‘
// btnStartScanner.addEventListener('click', ()=>{ ... });

btnStop.addEventListener('click', ()=>{
    if(html5QrScanner){
        html5QrScanner.stop().then(()=>{
            html5QrScanner.clear(); 
            html5QrScanner=null; 
            appendLog('ç›¸æ©Ÿå·²åœæ­¢'); 
            statusEl.textContent='å·²åœæ­¢';
            isScanning = false; // åœæ­¢æƒæ
            btnSync.disabled = false; // åœæ­¢å¾Œå•Ÿç”¨ä¸Šå‚³
        }).catch(e=>console.error(e)); 
    }
    // ã€å·²ç§»é™¤åœæ­¢åˆ·æ§æ¨¡å¼çš„é‚è¼¯ã€‘
    
    stopBatchTimer();
    
    // å¦‚æœç›¸æ©Ÿæ²’æœ‰å•Ÿå‹•ï¼Œç¢ºä¿ç‹€æ…‹æ­£ç¢º
    if (!isScanning) {
        statusEl.textContent = 'å·²åœæ­¢';
    }
});

// ã€å·²ç§»é™¤ startScannerMode å’Œ stopScannerMode è¼”åŠ©å‡½å¼ã€‘

btnSync.addEventListener('click', ()=>{ 
    // ã€ä¿®æ”¹é»ã€‘å¦‚æœæ­£åœ¨æƒæï¼Œå½ˆå‡ºè­¦å‘Šä¸¦è¿”å›
    if(isScanning){
        alert('è«‹å…ˆé»æ“Šã€Œåœæ­¢ã€æŒ‰éˆ•çµæŸæƒæä½œæ¥­ï¼');
        return;
    }
    sendBatch();
});

// ã€å·²ç§»é™¤é¸æ“‡å°ˆè»Šç·¨è™Ÿ/è³£å®¶åˆ‡æ›äº‹ä»¶ã€‘
// whTruckNumberSelect.addEventListener('change', () => { ... });
// sellerSelect.addEventListener('change', () => { ... });


// åˆå§‹è¼‰å…¥ï¼š
loadLocalBuffer(); // æ¢å¾©é›¢ç·šç·©å­˜
// loadTrucks(); // è¼‰å…¥å°ˆè»Šæ¸…å–® (å·²è¨»è§£)
// loadSellers(); // è¼‰å…¥è³£å®¶æ¸…å–® (å·²è¨»è§£)
// è‡ªå‹•é‡è©¦ä¸Šå‚³(ç¶²è·¯å¾©åŸæ™‚)
window.addEventListener('online', ()=>{ appendLog('ç¶²è·¯å›å¾©ï¼Œé–‹å§‹ä¸Šå‚³'); sendBatch(); });
</script>
</body>
</html>
